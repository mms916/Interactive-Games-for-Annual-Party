<!--
    ==================== èƒŒæ™¯éŸ³ä¹æ§åˆ¶å™¨ ====================
    å°†æ­¤ä»£ç ç‰‡æ®µå¤åˆ¶åˆ°æ¯ä¸ªHTMLæ–‡ä»¶çš„ </body> æ ‡ç­¾ä¹‹å‰
    ========================================================
-->

<!-- éŸ³ä¹æ’­æ”¾å™¨ï¼ˆéšè—ï¼‰ -->
<audio id="bgMusic" loop preload="auto">
    <!-- æ–¹æ¡ˆAï¼šä½¿ç”¨åœ¨çº¿éŸ³ä¹ï¼ˆæ¨èï¼‰ -->
    <source src="https://music.163.com/song/media/outer/url?id=186016.mp3" type="audio/mpeg">
    <!-- æ–¹æ¡ˆBï¼šä½¿ç”¨æœ¬åœ°éŸ³ä¹æ–‡ä»¶ -->
    <!-- <source src="./music/background.mp3" type="audio/mpeg"> -->
</audio>

<!-- éŸ³ä¹æ§åˆ¶å™¨æŒ‰é’® -->
<div class="music-controller" id="musicController">
    <div class="music-icon" id="musicIcon">ğŸµ</div>
</div>

<!-- éŸ³ä¹æ§åˆ¶å™¨æ ·å¼ -->
<style>
    .music-controller {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.6);
        border: 2px solid rgba(255, 215, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 9999;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }

    .music-controller:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        border-color: rgba(255, 215, 0, 0.9);
    }

    .music-icon {
        font-size: 30px;
        color: #FFD700;
        transition: all 0.3s ease;
    }

    /* æ’­æ”¾æ—¶çš„æ—‹è½¬åŠ¨ç”» */
    .music-controller.playing .music-icon {
        animation: musicRotate 3s linear infinite;
    }

    @keyframes musicRotate {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    /* éŸ³æ³¢åŠ¨ç”»ï¼ˆæ’­æ”¾æ—¶æ˜¾ç¤ºï¼‰ */
    .music-controller.playing::after {
        content: '';
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid rgba(255, 215, 0, 0.4);
        animation: musicPulse 1.5s ease-out infinite;
    }

    @keyframes musicPulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        100% {
            transform: scale(1.5);
            opacity: 0;
        }
    }

    /* å“åº”å¼é€‚é… */
    @media (max-width: 768px) {
        .music-controller {
            width: 50px;
            height: 50px;
            bottom: 15px;
            right: 15px;
        }

        .music-icon {
            font-size: 24px;
        }
    }
</style>

<!-- éŸ³ä¹æ§åˆ¶å™¨JavaScript -->
<script>
    // ========== éŸ³ä¹æ§åˆ¶å™¨é…ç½® ==========
    const MUSIC_CONFIG = {
        volume: 0.5,           // é»˜è®¤éŸ³é‡ï¼š50%
        autoPlay: true,        // æ˜¯å¦è‡ªåŠ¨æ’­æ”¾
        storageKey: 'bgMusicPlaying'  // localStorageå­˜å‚¨é”®å
    };

    // ========== éŸ³ä¹æ§åˆ¶å™¨ç±» ==========
    class MusicController {
        constructor() {
            this.audio = document.getElementById('bgMusic');
            this.controller = document.getElementById('musicController');
            this.icon = document.getElementById('musicIcon');
            this.isPlaying = false;
            this.userInteracted = false;

            this.init();
        }

        init() {
            // è®¾ç½®éŸ³é‡
            this.audio.volume = MUSIC_CONFIG.volume;

            // ä»localStorageè¯»å–æ’­æ”¾çŠ¶æ€
            const savedState = localStorage.getItem(MUSIC_CONFIG.storageKey);
            if (savedState === 'true') {
                this.isPlaying = true;
                this.updateUI();
            }

            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            this.controller.addEventListener('click', () => this.toggle());

            // ç›‘å¬ç”¨æˆ·é¦–æ¬¡äº¤äº’ï¼Œå°è¯•è‡ªåŠ¨æ’­æ”¾
            document.addEventListener('click', () => this.handleFirstInteraction(), { once: true });
            document.addEventListener('keydown', () => this.handleFirstInteraction(), { once: true });

            // ç›‘å¬éŸ³é¢‘æ’­æ”¾ç»“æŸï¼ˆå¾ªç¯æ’­æ”¾ï¼‰
            this.audio.addEventListener('ended', () => {
                this.audio.currentTime = 0;
                this.audio.play();
            });

            // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶å¤„ç†æ’­æ”¾
            document.addEventListener('visibilitychange', () => this.handleVisibilityChange());
        }

        handleFirstInteraction() {
            if (this.userInteracted) return;
            this.userInteracted = true;

            // å¦‚æœä¹‹å‰æ˜¯æ’­æ”¾çŠ¶æ€ï¼Œåˆ™æ¢å¤æ’­æ”¾
            if (this.isPlaying) {
                this.play();
            }
        }

        handleVisibilityChange() {
            // é¡µé¢éšè—æ—¶æš‚åœï¼Œæ˜¾ç¤ºæ—¶æ¢å¤ï¼ˆå¯é€‰ï¼‰
            // if (document.hidden && this.isPlaying) {
            //     this.audio.pause();
            // } else if (!document.hidden && this.isPlaying && this.userInteracted) {
            //     this.audio.play();
            // }
        }

        toggle() {
            this.userInteracted = true;

            if (this.isPlaying) {
                this.pause();
            } else {
                this.play();
            }
        }

        play() {
            const playPromise = this.audio.play();

            if (playPromise !== undefined) {
                playPromise.then(() => {
                    this.isPlaying = true;
                    this.saveState();
                    this.updateUI();
                }).catch(error => {
                    console.log('æ’­æ”¾å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·äº¤äº’:', error);
                    this.isPlaying = false;
                    this.updateUI();
                });
            }
        }

        pause() {
            this.audio.pause();
            this.isPlaying = false;
            this.saveState();
            this.updateUI();
        }

        saveState() {
            localStorage.setItem(MUSIC_CONFIG.storageKey, this.isPlaying.toString());
        }

        updateUI() {
            if (this.isPlaying) {
                this.controller.classList.add('playing');
                this.icon.textContent = 'ğŸµ';
            } else {
                this.controller.classList.remove('playing');
                this.icon.textContent = 'ğŸ”‡';
            }
        }
    }

    // ========== é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–éŸ³ä¹æ§åˆ¶å™¨ ==========
    document.addEventListener('DOMContentLoaded', function() {
        // é¿å…é‡å¤åˆå§‹åŒ–
        if (!window.musicControllerInstance) {
            window.musicControllerInstance = new MusicController();
        }
    });
</script>

<!--
    ==================== ä½¿ç”¨è¯´æ˜ ====================
    1. å°†ä»¥ä¸Šä»£ç å®Œæ•´å¤åˆ¶åˆ°æ¯ä¸ªHTMLæ–‡ä»¶çš„ </body> æ ‡ç­¾ä¹‹å‰
    2. ç¡®ä¿æ¯ä¸ªé¡µé¢åªå¼•å…¥ä¸€æ¬¡æ­¤ä»£ç 
    3. éŸ³ä¹æ–‡ä»¶å¯æ ¹æ®éœ€è¦ä¿®æ”¹ï¼š
       - ä½¿ç”¨åœ¨çº¿éŸ³ä¹ï¼šä¿®æ”¹ <source> æ ‡ç­¾çš„ src å±æ€§
       - ä½¿ç”¨æœ¬åœ°éŸ³ä¹ï¼šå–æ¶ˆæ³¨é‡Šæœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼Œå¹¶å‡†å¤‡éŸ³ä¹æ–‡ä»¶
    ==================================================
-->
