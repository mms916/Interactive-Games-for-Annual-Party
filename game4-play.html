<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°æ˜¯å§åº• - æ¸¸æˆä¸­</title>
    <style>
        /* ========== å…¨å±€æ ·å¼ ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #8E0E00 0%, #1F1C18 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 40px;
        }

        /* ========== é¡¶éƒ¨ä¿¡æ¯æ  ========== */
        .header {
            width: 100%;
            max-width: 1400px;
            background: linear-gradient(145deg, rgba(211, 47, 47, 0.95), rgba(183, 28, 28, 0.95));
            border-radius: 20px;
            padding: 20px 40px;
            margin-bottom: 30px;
            border: 2px solid #FFD700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-title {
            font-size: 36px;
            font-weight: bold;
            color: #FFD700;
        }

        .round-info {
            font-size: 32px;
            font-weight: bold;
            color: #FFF;
        }

        .round-number {
            color: #FFD700;
        }

        /* ========== ä¸»å†…å®¹åŒº ========== */
        .main-content {
            flex: 1;
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* ç©å®¶çŠ¶æ€åŒºåŸŸ */
        .players-section {
            background: linear-gradient(145deg, rgba(211, 47, 47, 0.9), rgba(183, 28, 28, 0.9));
            border-radius: 20px;
            padding: 30px 40px;
            border: 2px solid #FFD700;
        }

        .section-title {
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 20px;
            text-align: center;
        }

        .players-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .player-card {
            padding: 20px 30px;
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.4);
            text-align: center;
            transition: all 0.3s ease;
        }

        .player-card.alive {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        .player-card.out {
            border-color: #999;
            background: rgba(153, 153, 153, 0.2);
            opacity: 0.6;
        }

        .player-number {
            font-size: 32px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 8px;
        }

        .player-status {
            font-size: 24px;
            color: #FFF;
        }

        .player-role {
            font-size: 22px;
            margin-top: 8px;
            font-weight: bold;
        }

        .player-role.civilian { color: #2196F3; }
        .player-role.spy { color: #F44336; }
        .player-role.blank { color: #FF9800; }

        /* æ§åˆ¶åŒºåŸŸ */
        .control-section {
            background: linear-gradient(145deg, rgba(211, 47, 47, 0.9), rgba(183, 28, 28, 0.9));
            border-radius: 20px;
            padding: 30px 40px;
            border: 2px solid #FFD700;
        }

        .control-hint {
            font-size: 28px;
            color: #FFE082;
            text-align: center;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        /* æŒ‰é’®åŒºåŸŸ */
        .buttons-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .btn {
            padding: 18px 40px;
            font-size: 26px;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            min-width: 180px;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-danger {
            background: linear-gradient(145deg, #F44336, #D32F2F);
            color: #FFF;
        }

        .btn-danger:hover:not(:disabled) {
            background: linear-gradient(145deg, #EF5350, #F44336);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
        }

        .btn-info {
            background: linear-gradient(145deg, #2196F3, #1976D2);
            color: #FFF;
        }

        .btn-info:hover:not(:disabled) {
            background: linear-gradient(145deg, #42A5F5, #2196F3);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }

        .btn-warning {
            background: linear-gradient(145deg, #FF9800, #F57C00);
            color: #FFF;
        }

        .btn-warning:hover:not(:disabled) {
            background: linear-gradient(145deg, #FFB74D, #FF9800);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.4);
        }

        /* è¯è¯­æ˜¾ç¤º */
        .words-display {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 20px 30px;
            margin-top: 20px;
            display: none;
        }

        .words-display.show {
            display: block;
        }

        .word-item {
            font-size: 26px;
            color: #FFE082;
            margin-bottom: 10px;
        }

        .word-item .label {
            color: #FFD700;
            font-weight: bold;
        }

        /* ========== è£…é¥°å…ƒç´  ========== */
        .decoration {
            position: fixed;
            font-size: 30px;
            opacity: 0.25;
            animation: decorationFloat 6s ease-in-out infinite;
            pointer-events: none;
        }

        .decoration-1 { top: 8%; left: 5%; animation-delay: 0s; }
        .decoration-2 { top: 15%; right: 6%; animation-delay: 1.2s; }
        .decoration-3 { bottom: 12%; left: 8%; animation-delay: 2.4s; }
        .decoration-4 { bottom: 18%; right: 4%; animation-delay: 3.6s; }

        @keyframes decorationFloat {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            50% {
                transform: translateY(-15px) rotate(6deg);
            }
        }

        /* ========== å“åº”å¼é€‚é… ========== */
        @media (max-width: 1100px) {
            .players-grid {
                gap: 15px;
            }
            .player-card {
                padding: 15px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- è£…é¥°å…ƒç´  -->
    <div class="decoration decoration-1">ğŸ•µï¸</div>
    <div class="decoration decoration-2">ğŸ”</div>
    <div class="decoration decoration-3">ğŸ­</div>
    <div class="decoration decoration-4">ğŸª</div>

    <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
    <div class="header">
        <div class="header-title">ğŸ•µï¸ è°æ˜¯å§åº•</div>
        <div class="round-info">
            ç¬¬ <span class="round-number" id="roundNumber">1</span> è½®
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- ç©å®¶çŠ¶æ€åŒºåŸŸ -->
        <div class="players-section">
            <h2 class="section-title">ç©å®¶çŠ¶æ€</h2>
            <div class="players-grid" id="playersGrid">
                <!-- åŠ¨æ€ç”Ÿæˆç©å®¶å¡ç‰‡ -->
            </div>
        </div>

        <!-- æ§åˆ¶åŒºåŸŸ -->
        <div class="control-section">
            <div class="control-hint" id="controlHint">
                è¯·å„ä½ç©å®¶ä¾æ¬¡æè¿°è‡ªå·±çš„è¯è¯­ï¼Œæè¿°å®Œæ¯•åæŠ•ç¥¨
            </div>
            <div class="buttons-grid" id="buttonsGrid">
                <!-- åŠ¨æ€ç”ŸæˆæŒ‰é’® -->
            </div>
            <div class="words-display" id="wordsDisplay">
                <div class="word-item">
                    <span class="label">å¹³æ°‘è¯è¯­ï¼š</span>
                    <span id="civilianWordDisplay"></span>
                </div>
                <div class="word-item">
                    <span class="label">å§åº•è¯è¯­ï¼š</span>
                    <span id="spyWordDisplay"></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== æ¸¸æˆçŠ¶æ€ ==========
        let gameState = {
            playerRoles: [],
            civilianWord: '',
            spyWord: '',
            playerCount: 0,
            playersStatus: [], // true=å­˜æ´», false=å‡ºå±€
            currentRound: 1,
            wordsVisible: false
        };

        // ========== DOMå…ƒç´  ==========
        const roundNumber = document.getElementById('roundNumber');
        const playersGrid = document.getElementById('playersGrid');
        const buttonsGrid = document.getElementById('buttonsGrid');
        const controlHint = document.getElementById('controlHint');
        const wordsDisplay = document.getElementById('wordsDisplay');
        const civilianWordDisplay = document.getElementById('civilianWordDisplay');
        const spyWordDisplay = document.getElementById('spyWordDisplay');

        // ========== åˆå§‹åŒ–æ¸¸æˆ ==========
        function initGame() {
            // ä»localStorageè¯»å–æ¸¸æˆæ•°æ®
            const dataStr = localStorage.getItem('game4_data');
            if (!dataStr) {
                window.location.href = 'game4-setup.html';
                return;
            }

            const data = JSON.parse(dataStr);
            gameState.playerRoles = data.playerRoles;
            gameState.civilianWord = data.civilianWord;
            gameState.spyWord = data.spyWord;
            gameState.playerCount = data.playerCount;
            gameState.playersStatus = new Array(data.playerCount).fill(true);

            // æ˜¾ç¤ºè¯è¯­
            civilianWordDisplay.textContent = gameState.civilianWord;
            spyWordDisplay.textContent = gameState.spyWord;

            // æ¸²æŸ“ç•Œé¢
            renderPlayers();
            renderButtons();
            updateRoundDisplay();

            // é¡µé¢æ·¡å…¥åŠ¨ç”»
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
        }

        // ========== æ¸²æŸ“ç©å®¶åˆ—è¡¨ ==========
        function renderPlayers() {
            playersGrid.innerHTML = '';

            for (let i = 0; i < gameState.playerCount; i++) {
                const playerCard = document.createElement('div');
                const isAlive = gameState.playersStatus[i];

                playerCard.className = 'player-card' + (isAlive ? ' alive' : ' out');

                let statusHTML = `<div class="player-status">${isAlive ? 'å­˜æ´»' : 'å‡ºå±€'}</div>`;

                if (!isAlive) {
                    // æ˜¾ç¤ºè§’è‰²
                    const role = gameState.playerRoles[i];
                    let roleText = '';
                    let roleClass = '';
                    switch (role) {
                        case 'civilian':
                            roleText = 'å¹³æ°‘';
                            roleClass = 'civilian';
                            break;
                        case 'spy':
                            roleText = 'å§åº•';
                            roleClass = 'spy';
                            break;
                        case 'blank':
                            roleText = 'ç™½æ¿';
                            roleClass = 'blank';
                            break;
                    }
                    statusHTML += `<div class="player-role ${roleClass}">${roleText}</div>`;
                }

                playerCard.innerHTML = `
                    <div class="player-number">${i + 1}å·ç©å®¶</div>
                    ${statusHTML}
                `;

                playersGrid.appendChild(playerCard);
            }
        }

        // ========== æ¸²æŸ“æŒ‰é’® ==========
        function renderButtons() {
            buttonsGrid.innerHTML = '';

            // ä¸ºæ¯ä¸ªå­˜æ´»ç©å®¶ç”Ÿæˆå‡ºå±€æŒ‰é’®
            for (let i = 0; i < gameState.playerCount; i++) {
                if (gameState.playersStatus[i]) {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-danger';
                    btn.textContent = `${i + 1}å·å‡ºå±€`;
                    btn.onclick = () => playerOut(i);
                    buttonsGrid.appendChild(btn);
                }
            }

            // æŸ¥çœ‹è¯è¯­æŒ‰é’®
            const viewWordsBtn = document.createElement('button');
            viewWordsBtn.className = 'btn btn-info';
            viewWordsBtn.textContent = gameState.wordsVisible ? 'éšè—è¯è¯­' : 'æŸ¥çœ‹è¯è¯­';
            viewWordsBtn.onclick = toggleWords;
            buttonsGrid.appendChild(viewWordsBtn);

            // ç»“æŸæ¸¸æˆæŒ‰é’®
            const endGameBtn = document.createElement('button');
            endGameBtn.className = 'btn btn-warning';
            endGameBtn.textContent = 'ç»“æŸæ¸¸æˆ';
            endGameBtn.onclick = endGame;
            buttonsGrid.appendChild(endGameBtn);
        }

        // ========== æ›´æ–°è½®æ¬¡æ˜¾ç¤º ==========
        function updateRoundDisplay() {
            roundNumber.textContent = gameState.currentRound;
        }

        // ========== ç©å®¶å‡ºå±€ ==========
        function playerOut(playerIndex) {
            if (!gameState.playersStatus[playerIndex]) return;

            // æ ‡è®°ç©å®¶å‡ºå±€
            gameState.playersStatus[playerIndex] = false;

            // è½®æ¬¡+1
            gameState.currentRound++;

            // æ›´æ–°ç•Œé¢
            renderPlayers();
            renderButtons();
            updateRoundDisplay();

            // æ£€æŸ¥æ¸¸æˆæ˜¯å¦ç»“æŸ
            checkGameEnd();
        }

        // ========== åˆ‡æ¢è¯è¯­æ˜¾ç¤º ==========
        function toggleWords() {
            gameState.wordsVisible = !gameState.wordsVisible;
            if (gameState.wordsVisible) {
                wordsDisplay.classList.add('show');
            } else {
                wordsDisplay.classList.remove('show');
            }
            renderButtons();
        }

        // ========== æ£€æŸ¥æ¸¸æˆç»“æŸ ==========
        function checkGameEnd() {
            // ç»Ÿè®¡å„è§’è‰²å­˜æ´»äººæ•°
            let aliveCivilian = 0;
            let aliveSpy = 0;
            let aliveBlank = 0;

            for (let i = 0; i < gameState.playerCount; i++) {
                if (gameState.playersStatus[i]) {
                    const role = gameState.playerRoles[i];
                    switch (role) {
                        case 'civilian':
                            aliveCivilian++;
                            break;
                        case 'spy':
                            aliveSpy++;
                            break;
                        case 'blank':
                            aliveBlank++;
                            break;
                    }
                }
            }

            let gameResult = null;

            // åˆ¤æ–­æ¸¸æˆç»“æœ
            if (aliveSpy === 0) {
                // æ‰€æœ‰å§åº•å‡ºå±€ï¼Œå¹³æ°‘èƒœåˆ©
                gameResult = 'civilian_win';
            } else if (aliveSpy >= aliveCivilian + aliveBlank) {
                // å§åº•äººæ•° >= å¹³æ°‘+ç™½æ¿äººæ•°ï¼Œå§åº•èƒœåˆ©
                gameResult = 'spy_win';
            } else if (aliveBlank > 0 && aliveSpy === 0 && aliveCivilian === 0) {
                // åªå‰©ç™½æ¿ï¼Œç™½æ¿èƒœåˆ©
                gameResult = 'blank_win';
            } else if (aliveBlank > 0 && aliveCivilian === 0) {
                // åªå‰©ç™½æ¿å’Œå§åº•ï¼Œç™½æ¿èƒœåˆ©ï¼ˆç™½æ¿å­˜æ´»åˆ°æœ€åï¼‰
                gameResult = 'blank_win';
            }

            // å¦‚æœæ¸¸æˆç»“æŸï¼Œè·³è½¬åˆ°ç»“ç®—é¡µ
            if (gameResult) {
                saveGameResult(gameResult);
                setTimeout(() => {
                    window.location.href = 'game4-result.html';
                }, 1500);
            }
        }

        // ========== ä¿å­˜æ¸¸æˆç»“æœ ==========
        function saveGameResult(result) {
            const resultData = {
                gameResult: result,
                playerRoles: gameState.playerRoles,
                civilianWord: gameState.civilianWord,
                spyWord: gameState.spyWord,
                rounds: gameState.currentRound - 1,
                playersStatus: gameState.playersStatus
            };
            localStorage.setItem('game4_result', JSON.stringify(resultData));
        }

        // ========== ç»“æŸæ¸¸æˆ ==========
        function endGame() {
            // æ‰‹åŠ¨ç»“æŸæ¸¸æˆï¼Œè®¡ç®—ç»“æœ
            let aliveCivilian = 0;
            let aliveSpy = 0;

            for (let i = 0; i < gameState.playerCount; i++) {
                if (gameState.playersStatus[i]) {
                    const role = gameState.playerRoles[i];
                    if (role === 'civilian') aliveCivilian++;
                    else if (role === 'spy') aliveSpy++;
                }
            }

            let result;
            if (aliveSpy === 0) {
                result = 'civilian_win';
            } else {
                result = 'spy_win';
            }

            saveGameResult(result);
            window.location.href = 'game4-result.html';
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initGame);
    </script>

    <!-- éŸ³ä¹æ§åˆ¶å™¨ -->
    <audio id="bgMusic" loop preload="auto">
        <source src="./music/background.mp3" type="audio/mpeg">
    </audio>

    <div class="music-controller" id="musicController">
        <div class="music-icon" id="musicIcon">ğŸµ</div>
    </div>

    <style>
        .music-controller {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 215, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .music-controller:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
            border-color: rgba(255, 215, 0, 0.9);
        }
        .music-icon {
            font-size: 30px;
            color: #FFD700;
            transition: all 0.3s ease;
        }
        .music-controller.playing .music-icon {
            animation: musicRotate 3s linear infinite;
        }
        @keyframes musicRotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .music-controller.playing::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(255, 215, 0, 0.4);
            animation: musicPulse 1.5s ease-out infinite;
        }
        @keyframes musicPulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        @media (max-width: 768px) {
            .music-controller {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
            }
            .music-icon {
                font-size: 24px;
            }
        }
    </style>

    <script>
        const MUSIC_CONFIG = { volume: 0.5, autoPlay: true, storageKey: 'bgMusicPlaying' };
        class MusicController {
            constructor() {
                this.audio = document.getElementById('bgMusic');
                this.controller = document.getElementById('musicController');
                this.icon = document.getElementById('musicIcon');
                this.isPlaying = false;
                this.userInteracted = false;
                this.init();
            }
            init() {
                this.audio.volume = MUSIC_CONFIG.volume;
                const savedState = localStorage.getItem(MUSIC_CONFIG.storageKey);
                if (savedState === 'true') {
                    this.isPlaying = true;
                    this.updateUI();
                }
                this.controller.addEventListener('click', () => this.toggle());
                document.addEventListener('click', () => this.handleFirstInteraction(), { once: true });
                document.addEventListener('keydown', () => this.handleFirstInteraction(), { once: true });
                this.audio.addEventListener('ended', () => {
                    this.audio.currentTime = 0;
                    this.audio.play();
                });
            }
            handleFirstInteraction() {
                if (this.userInteracted) return;
                this.userInteracted = true;
                if (this.isPlaying) this.play();
            }
            toggle() {
                this.userInteracted = true;
                if (this.isPlaying) this.pause();
                else this.play();
            }
            play() {
                const playPromise = this.audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        this.isPlaying = true;
                        this.saveState();
                        this.updateUI();
                    }).catch(() => {
                        this.isPlaying = false;
                        this.updateUI();
                    });
                }
            }
            pause() {
                this.audio.pause();
                this.isPlaying = false;
                this.saveState();
                this.updateUI();
            }
            saveState() {
                localStorage.setItem(MUSIC_CONFIG.storageKey, this.isPlaying.toString());
            }
            updateUI() {
                if (this.isPlaying) {
                    this.controller.classList.add('playing');
                    this.icon.textContent = 'ğŸµ';
                } else {
                    this.controller.classList.remove('playing');
                    this.icon.textContent = 'ğŸ”‡';
                }
            }
        }
        document.addEventListener('DOMContentLoaded', function() {
            if (!window.musicControllerInstance) {
                window.musicControllerInstance = new MusicController();
            }
        });
    </script>
</body>
</html>
